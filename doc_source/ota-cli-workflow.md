# Creating an OTA Update with the AWS CLI<a name="ota-cli-workflow"></a>

To create an OTA update with the AWS CLI you:

1. Digitally sign your firmware image\.

1. Create a stream of your digitally signed firmware image\.

1. Start an OTA update job\.

## Digitally Signing your Firmware Update<a name="ota-sign-cli"></a>

When using the CLI to perform OTA updates you can use Code Signing for Amazon FreeRTOS or sign your firmware update yourself\.

### Signing your Firmware Image with Code Signing for Amazon FreeRTOS<a name="ota-sign-csfa"></a>

To sign your firmware image using Code Signing for Amazon FreeRTOS, you must install the [Code Signing Tools](https://tools.signer.aws.a2z.com/awssigner-tools.zip)\. Download the tools and read the README file for installation instructions\. For more information about Code Signing for Amazon FreeRTOS, see [Code Signing for Amazon FreeRTOS](https://docs.aws.amazon.com/signer/latest/developerguide/Welcome.html)\. After installing and configuring the code signing tools, copy your unsigned firmware image to your Amazon S3 bucket and start a code signing job with the following CLI command:

```
aws signer start-signing-job --source 's3={bucketName=<your-source-bucket-name>,
key=<your-image-file-name>, version=<your-s3-file-version>}' --destination 's3={bucketName=<your-destination-bucket-name>}' --signing-material "certificateArn=arn:aws:acm::<your-region>:<your-aws-account-id>:certificate/<your-certificate-id>" --signing-parameters certname=<cert.pem> --platform <your-hardware-platform>
```

**Note**  
*<your\-source\-bucket\-name>* and *<your\-destination\-bucket\-name>* can be the same Amazon S3 bucket\.

The following text describes the parameters for the `start-signing-job` command:

`source`  
Specifies the location of the unsigned firmware in an S3 bucket\.  
+ `bucketName` \- the name of your S3 bucket\.
+ `key` \- the key \(file name\) of your firmware in your S3 bucket\.
+ `version` \- the S3 version of your firmware in your S3 bucket\. This is different from your firmware version and can be found by browsing to the Amazon S3 console, choosing your bucket, and on the top of the console screen next to **Versions**, choosing **Show**\.

`destination`  
Specifies the destination for the signed firmware in an S3 bucket\. The format of this parameter is the same as the `source` parameter\.

`signing-material`  
The ARN of your code signing certificate\. This ARN is generated when you import your certificate into ACM\.

`signing-parameters`  
A map of key\-value pairs for signing\. These can include any information that you want to use during signing\.

`platform`  
The hardware platform to which you are distributing the OTA update\. Valid values are:  
+ `TexasInstruments`
+ `MicrochipTechnologyInc`
+ `WindowsSimulator`

The signing job will start and write the signed firmware image into the destination Amazon S3 bucket\. The file name for the signed firmware image will be a GUID\. You will need this file name when creating a stream\. You can find the generated file name by browsing to the Amazon S3 console and choosing your bucket\. If you don't see a file with a GUID file name, refresh your browser\.

The command will display a job ARN and a job ID\. You will need these values later on\. For more information about Code Signing for Amazon FreeRTOS, see [Code Signing for Amazon FreeRTOS](https://docs.aws.amazon.com/signer/latest/developerguide/Welcome.html)\. 

### Signing your Firmware Image Manually<a name="ota-sign-manual"></a>

Digitally sign your firmware image and upload your signed firmware image into your Amazon S3 bucket\.

## Creating a Stream of your Firmware Update<a name="ota-stream"></a>

The OTA Update service sends updates over MQTT messages\. To do this you must create a stream that contains your signed firmware update\. To do this create a JSON file \(stream\.json\) that identifies your signed firmware image\. The JSON file should contain the following:

```
[
{
    "fileId":<your_file_id>,
	"s3Location":{
	    "bucket":"<your_bucket_name>",
	    "key":"<your_s3_object_key<"
	}
}
]
```

The following list describes the attributes in the JSON file\.

`fileId`  
An arbitrary integer between 0 \- 255 that identifies your firmware image\.

`s3Location`  
The bucket and key for the firmware to stream\.    
`bucket`  
The Amazon S3 bucket where your unsigned firmware image is stored\.  
`key`  
The file name of your signed firmware image in the Amazon S3 bucket\. You can find this value in the Amazon S3 console by looking at the contents of your bucket\. If you are using Code Signing for Amazon FreeRTOS the file name will be a GUID generated by Code Signing for Amazon FreeRTOS\.

Use the `create-stream` CLI command to create a stream:

```
aws iot create-stream --stream-id <your_stream_id> --description <your_description> --files file://<stream.json> --role-arn <your_role_arn>
```

The following list describes the arguments for the `create-stream` CLI command\.

`stream-id`  
An arbitrary string to identify the stream\.

`description`  
An optional description of the stream\.

`files`  
One or more references to JSON files that contain data about firmware images to stream\. The json file must contain the following attributes:    
`fileId`  
An arbitrary file ID\.  
`s3Location`  
Contains the bucket name where the signed firmware image is stored and the key \(file name\) of the signed firmware image\.  
`bucket`  
The Amazon S3 bucket where the signed firmware image is stored\.  
`key`  
The key \(file name\) of the signed firmware image\. When using Code Signing for Amazon FreeRTOS this will be a GUID\.
The following is an example stream\.json file:  

```
[
{
    "fileId":123,                                         
	"s3Location":{
	    "bucket":"codesign-ota-bucket",                     
	    "key":"48c67f3c-63bb-4f92-a98a-4ee0fbc2bef6"         
	}
}
]
```

`role-arn`  
An IAM role that grants access to the Amazon S3 bucket

To find the Amazon S3 object key of your signed firmware image, use the `aws signer describe-signing-job --job-id <my-job-id>` command where `my-job-id` is the job ID displayed by the `create-signing-job` CLI command\. The output of the `describe-signing-job` command will contain the key of the signed firmware image\. For example:

```
... text deleted for brevity ...
	"signedObject": {
        "s3": {
            "bucketName": "ota-bucket",
            "key": "7309da2c-9111-48ac-8ee4-5a4262af4429"
        }
    }
... text deleted for brevity ...
```

## Creating an OTA Update<a name="create-ota-update"></a>

Use the `create-ota-update` CLI command to create an OTA update job:

```
aws iot create-ota-update --ota-update-id "<my_ota_update>" --target-selection SNAPSHOT --description "<a cli ota update>" --files file://<ota.json> --targets arn:aws:iot:<your-aws-region>:<your-aws-account>:thing/<your-thing-name> --role-arn arn:aws:iam::<your-aws-account>:role/<your-ota-service-role
```

**Note**  
Do not use any personally identifiable information \(PII\) in your OTA update job ID\. Examples of personally identifiable information include:  
Your name
Your IP address
Your email address
Your location
Bank details
Medical information

`ota-update-id`  
An arbitrary OTA update ID\.

`target-selection`  
Valid values are:  
+ `SNAPSHOT`: The job will terminate after deploying the update to the selected IoT thing or groups\.
+ `CONTINUOUS`: The job will continue to deploy updates to devices added to the selected groups\.

`description`  
A text description of the OTA update\.

`files`  
One or more references to JSON files that contain data about the OTA update\. The JSON file can contain the following attributes:  
+ `fileName`: The fully qualified firmware image file name\. For Texas Instruments CC3200SF\-LAUNCHXL this must be `"/sys/mcuflashimg.bin"`\. For Microchip this must be `"mplab.production.bin"` 
+ `fileSource`: Contains information about the firmware update stream\.
  + `streamId`: The stream ID specified in the `create-stream` CLI command\.
  + `fileId`: The file ID specified in the JSON file passed to `create-stream`\.
+ `codeSigning`: Contains information about the code signing job\.
  + `awsSignerJobId`: The signer job ID generated by the `start-siging-job` command\.
  + `customCodeSigning`: Contains information about a custom signature\.
    + `signature`: Contains a custom signature\.
      + `inlineDocument`: The custom signature\.
      + `stream`: Contains information about a stream that contains a digital signature\.
        + `streamId`: The signature stream ID\.
        + `fileId`: The signature file ID\.
    + `certificateChain`: Contains a certificate chain for a custom signature\.
      + `inlineDocument`: The certificate chain\.
      + `stream`: Contains information about a stream that contains a certificate chain\.
        + `streamId`: The certificate chain stream ID\.
        + `fileId`: The certificate chain file ID\.
    + `hashAlgorithm`: The hash algorithm used to create the signature\.
    + `signatureAlgorithm`: The signature algorithm used for code signing\.
  + `attributes`: Arbitrary key/value pairs\.

`targets`  
One or more IoT thing ARNs that specify which devices will be updated by the OTA update\.

`role-arn`  
Your service role's ARN\.

The following is an example of a JSON file passed into the `create-ota-update` command that uses Code Signing for Amazon FreeRTOS :

```
[
{
    "fileName": "firmware.bin",                              
	"fileSource": {
	    "streamId": "004",                                               
	    "fileId":123                                                    
	},
	"codeSigning": {
		"awsSignerJobId": "48c67f3c-63bb-4f92-a98a-4ee0fbc2bef6"         
	}
}
]
```

The following is an example of a JSON file passed into the `create-ota-update` CLI command that uses an inline file to provide custom code signing material:

```
[
{
    "fileName": "firmware.bin",
	"fileSource": {
	    "streamId": "004",
	    "fileId": 123
	},
	"codeSigning": {
	    "customCodeSigning":{
            "signature":{
	            "inlineDocument":"<your_signature>"
	        },
	        "certificateChain": {
	            "inlineDocument":"<your_certificate_chain>"
	        },
	        "hashAlgorithm":"<your_hash_algorithm>",
	        "signatureAlgorithm":"<your_sig_algorithm>"
	    }
	}
}
]
```

The following is an example of a JSON file passed into the `create-ota-update` CLI command that uses a stream to provide custom code signing material:

```
[
{
    "fileName": "firmware.bin",
	"fileVersion": "1",
	"fileSource": {
	    "streamId": "004",
	    "fileId": 123
	},
	"codeSigning": {
	    "customCodeSigning":{
	        "signature":{
	            "stream": {
	                "streamId": "<signature-stream>",
	                "fileId": <signature-stream-file-id>
	            }
	        },
	        "certificateChain": {
	            "stream":{
	                "streamId": "<certificate-chain-stream-id>",
	                "fileId": <certificate-chain-file-id>
	            }
	       },
	       "hashAlgorithm":"<hash-algorithm>",
	       "signatureAlgorithm":"<signature-algorithm>"
	   },
	   "attributes": {
	       "key": "value"...
	   }
    }
}
]
```

You can use the `get-ota-update` CLI command to get the status of an OTA update:

```
aws iot get-ota-update --ota-update-id <your-ota-update-id>
```

This will return one of the following values:

`CREATE_PENDING`  

`CREATE_IN_PROGRESS`  

`CREATE_COMPLETE`  

`CREATE_FAILED`  

## Listing OTA Updates<a name="list-ota-updates"></a>

You can get a list of all OTA updates by using the `list-ota-updates` CLI command\. For example:

```
aws iot list-ota-updates
```

The output from the `list-ota-updates` command will look like this:

```
{
    "otaUpdates": [
       
        {
            "otaUpdateId": "my_ota_update2",
            "otaUpdateArn": "arn:aws:iot:us-west-2:123456789012:otaupdate/my_ota_update2",
            "creationDate": 1522778769.042
        },
        {
            "otaUpdateId": "my_ota_update1",
            "otaUpdateArn": "arn:aws:iot:us-west-2:123456789012:otaupdate/my_ota_update1",
            "creationDate": 1522775938.956
        },
        {
            "otaUpdateId": "my_ota_update",
            "otaUpdateArn": "arn:aws:iot:us-west-2:123456789012:otaupdate/my_ota_update",
            "creationDate": 1522775151.031
        }
    ]
}
```

## Getting Information About a Specific OTA Update<a name="get-ota-updates"></a>

You can get information about a specific OTA update by using the `get-ota-update` CLI command\. For example:

```
aws iot get-ota-update --ota-update-id <my-ota-update-id>
```

The output from the `get-ota-update` command will look like this:

```
{
    "otaUpdateInfo": {
        "otaUpdateId": "myotaupdate1",
        "otaUpdateArn":
        "arn:aws:iot:us-west-2:123456789012:otaupdate/my_ota_update",
        "creationDate": 1522444438.424,
        "lastModifiedDate": 1522444440.681,
        "description": "a test OTA update",
        "targets": [
            "arn:aws:iot:us-west-2:123456789012:thing/myDevice"
        ],
        "targetSelection": "SNAPSHOT",
        "otaUpdateFiles": [
            {
                "fileName": "app.bin",
                "fileSource": {
                    "streamId": "003",
                    "fileId": 123
                },
                "codeSigning": {
                    "awsSignerJobId": "592932bb-24a1-4f91-8ddd-66145352ad19",
                    "customCodeSigning": {}
                }
            }
        ],
        "otaUpdateStatus": "CREATE_COMPLETE",
        "awsIotJobId": "f76da3c0_10eb_41df_9029_ba7abc20f609",
        "awsIotJobArn": "arn:aws:iot:us-west-2:123456789012:job/f76da3c0_10eb_41df_9029_ba7abc20f609"
    }
}
```

## Deleting OTA\-Related Data<a name="delete-ota-data"></a>

Currently the AWS IoT console does not allow you to delete streams or OTA updates\. You can use the AWS CLI to delete streams, OTA updates, and the IoT jobs created during an OTA update\.

### Delete an OTA Stream<a name="delete-ota-stream"></a>

When you create an OTA update either you or the AWS IoT console creates a stream to break the firmware up into chunks so it can be sent over MQTT\. You can delete this stream with the `delete-stream` CLI command\. For example:

```
aws iot delete-stream --stream-id <your_stream_id>
```

### Deleting an OTA Update<a name="delete-ota-update"></a>

When you create an OTA update several things are created:
+ An entry in the OTA update job database\.
+ An AWS IoT job to perform the update\.
+ An AWS IoT job execution for each device being updated\.

The `delete-ota-update` command deletes the entry in the OTA update job database only\. You will still need to delete the AWS IoT job with the `delete-job` command explained below\.

To delete an OTA update use the `delete-ota-update` command:

```
aws iot delete-ota-update --ota-update-id <your_ota_update_id>
```

### Deleting an IoT Job Created for an OTA Update<a name="delete-ota-job"></a>

The Amazon FreeRTOS service creates an AWS IoT job when you create an OTA update\. A job execution is also created for each device that processes the job\. You can delete a job and it's associated job executions using the `delete-job` CLI command\. For example:

```
aws iot delete-job --job-id <your-job-id --no-force
```

The `no-force` parameter specifies that only jobs that are in a terminal state \("COMPLETED" or "CANCELLED"\) may be deleted\. You can delete a job that is in a non\-terminal state by passing the `force` parameter\. For more information on the `DeleteJob` API, see [DeleteJob API](http://docs.aws.amazon.com/iot/latest/apireference/API_DeleteJob.html)\.

**Note**  
Deleting a job which is "IN\_PROGRESS" will interrupt any job executions which are "IN\_PROGRESS" on your devices, and may result in a device being left in a non\-deterministic state\. Use caution and ensure that each device executing a job which is deleted is able to recover to a known state\.

Deleting a job may take some time, depending on the number of job executions created for the job and various other factors\. While the job is being deleted, the status of the job will be shown as "DELETION\_IN\_PROGRESS"\. Attempting to delete or cancel a job whose status is already "DELETION\_IN\_PROGRESS" will result in an error\.

You can delete an individual job execution using the `delete-job-execution`\. You may want to delete a job execution when a small number of devices are unable to process a job\. This will delete the job execution for a single device\. For example:

```
aws iot delete-job-execution --job-id <your-job-id --thing-name
					<your-thing-name> --execution-number
 <your-job-execution-number --no-force
```

As with the `delete-job` CLI command, you can pass the `--force` parameter to the `delete-job-execution` to force the deletion of an execution job execution\. For more information on the `DeleteJobExecution` API, see [DeleteJobExecution API](http://docs.aws.amazon.com/iot/latest/apireference/API_DeleteJobExecution.html)\.

**Note**  
Deleting a job execution which is "IN\_PROGRESS" will interrupt any job executions which are "IN\_PROGRESS" on your devices, and may result in a device being left in a non\-deterministic state\. Use caution and ensure that each device executing a job which is deleted is able to recover to a known state\.

For more information about using the OTA update demo application, see [OTA Demo Application](ota-demo.md)\.